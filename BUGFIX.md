# バグ修正レポート

## 修正日時
2025年10月10日

## バグ修正履歴

### 修正 #2: 年収の単位変換エラー（2025年10月10日）

**問題:**
年収750万円と入力したのに、限度額が1,000円と表示される

**原因:**
- UIでは「年収（万円）」と表示
- しかし内部処理では入力値をそのまま「円」として計算
- 750万円が750円として計算されていた

**修正内容:**
`src/app/profile/page.tsx`
1. 限度額計算時に万円→円に変換 (×10,000)
2. 保存時も万円→円に変換
3. 読み込み時に円→万円に変換（表示用）
4. プレースホルダーを「例: 750（750万円の場合）」に変更

**変更箇所:**
```typescript
// 計算時
const annualIncomeInYen = Number(annualIncome) * 10000;

// 読み込み時
const annualIncomeInManYen = Math.floor(user.income.annualIncome / 10000);
```

**テスト結果:**
- 年収750万円、既婚、扶養1人 → 限度額 約115,000円 ✓
- 年収500万円、独身、扶養0人 → 限度額 約61,000円 ✓

---

## 修正日時（初回）
2025年10月10日

## 報告された問題

### 1. Firestore undefined エラー
**エラーメッセージ:**
```
FirebaseError: Function updateDoc() called with invalid data.
Unsupported field value: undefined (found in field income.socialInsurance)
```

**原因:**
Firestoreは`undefined`値を保存できないが、オプショナルフィールド（社会保険料、住宅ローン控除）が未入力の場合に`undefined`が渡されていた。

**修正内容:**
1. `src/app/profile/page.tsx` - オプショナルフィールドの処理を改善
   - 空文字列チェックを追加
   - undefinedの代わりにフィールドを除外

2. `src/hooks/useAuth.tsx` - `updateUserData`関数を改善
   - 再帰的にundefinedフィールドを除去する`removeUndefinedFields`関数を追加
   - ネストされたオブジェクトにも対応

### 2. 限度額計算の精度
**問題:**
限度額計算が他のツールと大きく異なる値を表示

**原因:**
簡易計算式を使用していたため、所得税率を考慮していなかった。

**修正内容:**
`src/utils/furusatoCalculator.ts` - 計算式を改善
1. 累進課税の所得税率を計算に追加
2. 正確な控除上限額計算式を実装:
   ```
   上限額 = (住民税所得割額 × 20%) / (100% - 所得税率 × 1.021 - 10%) + 2,000円
   ```
3. 安全マージンを90%に変更（より保守的）

## 追加改善

### 1. ESLintエラー対応
- `.eslintignore`ファイルを作成
- ビルド生成ファイル（.next/, next-env.d.ts）を除外

### 2. UI改善
- 限度額計算結果に注意書きを追加:
  - 安全マージン90%適用の説明
  - 確定申告内容による変動の注意書き

## テスト手順

1. **プロファイル入力テスト**
   ```
   年収: 5,000,000円
   既婚: はい
   扶養人数: 1人
   社会保険料: （空欄）← undefinedエラーの確認
   住宅ローン控除: （空欄）
   ```

   **期待結果:**
   - エラーなく保存される
   - Firestoreに正しくデータが保存される
   - 限度額が正しく計算される

2. **限度額計算の確認**
   ```
   年収: 5,000,000円
   既婚、扶養1人

   期待値: 約 60,000円 前後
   ```

3. **オプショナルフィールドのテスト**
   ```
   社会保険料を入力した場合と未入力の場合で、
   両方ともエラーが発生しないことを確認
   ```

## 今後の改善提案

1. **限度額計算の精度向上**
   - 医療費控除の考慮
   - iDeCo等の小規模企業共済等掛金控除
   - 生命保険料控除

2. **エラーハンドリング**
   - より詳細なエラーメッセージ
   - バリデーションの強化

3. **ユーザビリティ**
   - 限度額の計算根拠を表示
   - 「詳細を見る」ボタンで計算内訳を表示

## 変更されたファイル

1. `src/app/profile/page.tsx` - オプショナルフィールド処理
2. `src/hooks/useAuth.tsx` - undefined除去処理
3. `src/utils/furusatoCalculator.ts` - 計算式改善
4. `.eslintignore` - 新規作成

## 動作確認済み

- [x] プロファイル保存（全フィールド入力）
- [x] プロファイル保存（オプショナルフィールド未入力）
- [x] 限度額計算
- [x] Firestoreへのデータ保存
- [x] ESLintエラーなし（ソースコード）

## 備考

- 限度額計算は総務省基準に基づく目安であり、実際の控除額は確定申告の内容により変動します
- 安全マージン90%を適用しているため、やや保守的な金額になります
