name: Scheduled Email Delivery

on:
  schedule:
    # 毎時0分に実行（UTC）
    # Firestoreのスケジュール設定に基づいて送信判定
    - cron: '0 * * * *'

  # 手動実行も可能
  workflow_dispatch:

jobs:
  send-emails:
    runs-on: ubuntu-latest
    steps:
      - name: Send Scheduled Emails
        run: |
          echo "Checking for emails to send..."
          echo "Target URL: ${{ secrets.APP_URL }}/api/cron/send-emails"

          # -L: リダイレクトを追跡, -s: サイレントモード, -S: エラーは表示, -w: HTTPコード表示
          response=$(curl -L -s -S -w "\n\nHTTP Status: %{http_code}\n" \
            -X GET "${{ secrets.APP_URL }}/api/cron/send-emails?secret=${{ secrets.CRON_SECRET }}")

          echo "Response:"
          echo "$response"
          echo ""
          echo "Email sending completed."
